@page "/certify"
@implements IDisposable
@inject Breadcrumbs breadcrumbs
@inject IDialogService DialogService
@inject NavigationManager nav;
@inject UserViewModel userViewModel

@inherits MvvmComponentBase<CertifyViewModel>

<MudGrid>
    <MudItem xs="12" sm="6">
        <MudPaper Class="pa-2">
            <MudText Color="@Color.Default">Code Name: @certifyViewModel.BolAccount.CodeName</MudText>
            <MudText Color="@Color.Default">Account Status: @certifyViewModel.BolAccount.AccountStatus</MudText>
            @if (!certifyViewModel.IsCertified)
            {
                if (certifyViewModel.MandatoryCertifiers != null && ViewModel.MandatoryCertifiers.Count > 0)
                {
                    foreach (var itm in ViewModel.MandatoryCertifiers)
                    {
                        <MudCheckBox @bind-Checked="@Size_CheckBox1" Size="Size.Small" Color="Color.Primary">itm.Key</MudCheckBox>
                    }
                }
                <MudTextField @bind-Value="@ViewModel.CertifierCodename" Label="Paste Certifier Codename" Variant="MudBlazor.Variant.Outlined"></MudTextField>
                <br/>
                <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="@(async z=> await certifyViewModel.SelectMandatoryCertifiersCommand.ExecuteAsync(null))">Select Mandatory Certifiers</MudButton>
                <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="@(async z=> await certifyViewModel.RequestCertificationCommand.ExecuteAsync(null))">Request Certification No.{0} out of 2</MudButton>
            } else
            {
                <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="@(async z=> await certifyViewModel.PayCertificationFeesCommand.ExecuteAsync(null))">Pay Certification Fees</MudButton>
            }
        </MudPaper>
    </MudItem>
</MudGrid>
@code {
    private bool Size_CheckBox1;
    CertifyViewModel certifyViewModel;
    protected override async Task OnInitializedAsync()
    {
        certifyViewModel = ViewModel;
        await certifyViewModel.Initialize();


        breadcrumbs._items = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/index-with-account", disabled: false),
            new BreadcrumbItem("Certify", href: null, disabled: true),
        };

        breadcrumbs.userData = userViewModel.userData;
        breadcrumbs.Update();
        breadcrumbs.OnButtonClick += HandleButton;
        
    }
    protected async void HandleButton(object sender, NavButtons args)
    {
        if (args == NavButtons.Refresh)
        {
            await certifyViewModel.UpdateBolAccountCommand.ExecuteAsync(null);

        }
        
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        breadcrumbs.OnButtonClick -= HandleButton;
    }
}
